name: 'Unity Cache'
description: 'Unity Project Cache Control Wrapper.'
author: 'AndanteTribe'
inputs:
  unity-project-path:
    description: 'A directory paths for the Unity project to be cached and restored.'
    required: true
  upload-chunk-size:
    description: 'The chunk size used to split up large files during upload, in bytes. Self-hosted runners are ignored.'
    required: false
  fail-on-cache-miss:
    description: 'Fail the workflow if cache entry is not found.'
    default: 'false'
    required: false
  lookup-only:
    description: 'Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache.'
    default: 'false'
    required: false
  use-nugetforunity:
    description: 'Supports cache resolution and cache management via NuGetForUnity.Cli in Unity projects using NuGetForUnity.'
    default: 'false'
    required: false
outputs:
  cache-hit-unity:
    description: 'A boolean value indicating that the cache for the target Unity project has been found.'
  cache-hit-nuget:
    description: 'A boolean value indicating that the NuGet cache for the target Unity project has been found.'
runs:
  using: "composite"
  steps:
    - name: Setup dotnet
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: "10.0.x"

    - name: Fetch unity project info (Windows)
      if: runner.os == 'Windows'
      id: info-windows
      env:
        UNITY_PROJECT_PATH: ${{ inputs.unity-project-path }}
      run: dotnet run -c Release src/share/unity-info/FetchUnityProjectInfo.cs
      shell: cmd
      working-directory: ${{ github.action_path }}/../..

    - name: Fetch unity project info (Mac/Linux)
      if: runner.os != 'Windows'
      id: info-unix
      env:
        UNITY_PROJECT_PATH: ${{ inputs.unity-project-path }}
      run: |
        docker build -t unity-info "${{ github.action_path }}/../../src/share/unity-info/"
        docker run --rm \
          -v "$GITHUB_WORKSPACE:$GITHUB_WORKSPACE" \
          -v "$(dirname "$GITHUB_OUTPUT"):$(dirname "$GITHUB_OUTPUT")" \
          -e UNITY_PROJECT_PATH \
          -e GITHUB_WORKSPACE \
          -e GITHUB_OUTPUT \
          unity-info
      shell: bash

    - name: Restore unity project cache (Windows)
      if: ${{ !contains(runner.labels, 'self-hosted') && runner.os == 'Windows' }}
      id: unity-cache-windows
      uses: actions/cache@v4
      with:
        path: ${{ inputs.unity-project-path }}/Library
        key: unity-cache-${{ steps.info-windows.outputs.name }}
        upload-chunk-size: ${{ inputs.upload-chunk-size }}
        fail-on-cache-miss: ${{ inputs.fail-on-cache-miss }}
        lookup-only: ${{ inputs.lookup-only }}

    - name: Restore unity project cache (Mac/Linux)
      if: ${{ !contains(runner.labels, 'self-hosted') && runner.os != 'Windows' }}
      id: unity-cache-unix
      uses: actions/cache@v4
      with:
        path: ${{ inputs.unity-project-path }}/Library
        key: unity-cache-${{ steps.info-unix.outputs.name }}
        upload-chunk-size: ${{ inputs.upload-chunk-size }}
        fail-on-cache-miss: ${{ inputs.fail-on-cache-miss }}
        lookup-only: ${{ inputs.lookup-only }}

    - name: Set outputs (Windows)
      if: runner.os == 'Windows'
      env:
        UNITY_CACHE_HIT: ${{ steps.unity-cache-windows.outputs.cache-hit }}
        NUGET_CACHE_HIT: false
      run: dotnet run -c Release src/cache/SetOutPuts.cs
      shell: cmd
      working-directory: ${{ github.action_path }}/../..

    - name: Set outputs (Mac/Linux)
      if: runner.os != 'Windows'
      env:
        UNITY_CACHE_HIT: ${{ steps.unity-cache-unix.outputs.cache-hit }}
        NUGET_CACHE_HIT: false
      run: dotnet run -c Release src/cache/SetOutPuts.cs
      shell: bash
      working-directory: ${{ github.action_path }}/../..